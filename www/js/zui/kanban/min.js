/*!
 * ZUI: ZUI Kanban View - v1.10.0 - 2021-11-16
 * http://openzui.com
 * GitHub: https://github.com/easysoft/zui.git 
 * Copyright (c) 2021 cnezsoft.com; Licensed MIT
 */
!function(a){"use strict";var n="zui.kanban",e="object"==typeof CSS&&CSS.supports("display","flex"),t=function(d,i){var o=this;o.name=n,o.$=a(d).addClass("kanban"),o.options=i=a.extend({},t.DEFAULTS,this.$.data(),i),o.data=i.data||[],o.render(o.data);var s=function(n){if(i.onAction){var e=a(this);i.onAction(e.data("action"),e,n,o)}};if(o.$.on("click",".action",s).on("dblclick",".action-dbc",s),"auto"===i.droppable&&(i.droppable=!i.readonly),i.droppable){var r=0,l={selector:".kanban-item",target:'.kanban-lane-col:not([data-type="EMPTY"])',drop:function(a){"function"==typeof i.droppable?i.droppable(a):i.onAction&&i.onAction("dropItem",a.element,a,o)},start:function(n){o.$.addClass("kanban-dragging"),r&&clearTimeout(r),r=setTimeout(function(){a(n.shadowElement).addClass("in"),r=0},50)},always:function(){o.$.removeClass("kanban-dragging"),r&&(clearTimeout(r),r=0)}};"object"==typeof i.droppable&&a.extend(l,i.droppable),o.$.droppable(l)}e&&i.useFlex||a(window).on("resize",function(){o.adjustSize()}),i.useFlex&&e||o.$.addClass("not-use-flex"),i.onCreate&&i.onCreate(o)};t.prototype.render=function(a){var n=this;a&&(n.data=a),n.data&&!Array.isArray(n.data)&&(n.data=[n.data]);var t=n.data||[];n.options.beforeRender&&n.options.beforeRender(n,t),n.$.toggleClass("kanban-readonly",!!n.options.readonly).toggleClass("kanban-no-lane-name",!!n.options.noLaneName),n.$.children(".kanban-board").addClass("kanban-expired");for(var d=0;d<t.length;++d)n.renderKanban(d);n.$.children(".kanban-expired").remove(),e&&n.options.useFlex||setTimeout(n.adjustSize.bind(this),200),n.options.onRender&&n.options.onRender(n)},t.prototype.renderKanban=function(n){if("number"==typeof n)n=this.data[n];else{var t=this.data.findIndex(function(a){return a.id===n.id});if(t>-1){var d=this.data[t];n=a.extend(d,n),this.data[t]=n}else this.data.push(n)}n.id||(n.id=a.zui.uuid());var i=this,o=i.$,s=o.children('.kanban-board[data-id="'+n.id+'"]');s.length?s.removeClass("kanban-expired"):(s=a('<div class="kanban-board" data-id="'+n.id+'"></div>').appendTo(o),e||s.addClass("no-flex")),i.renderKanbanHeader(n,s),s.children(".kanban-lane").addClass("kanban-expired");for(var r=n.lanes||[],l=0;l<r.length;++l){var c=r[l];c.$index=l,c.$kanbanData=n,i.renderLane(r[l],n.columns,s,n,t)}if(s.children(".kanban-expired").remove(),i.options.showCount)for(var l=0;l<n.columns.length;++l){var p=n.columns[l],h=s.find(".kanban-lane-col["+(p.asParent?'data-parent="'+p.type+'"':'data-type="'+p.type+'"')+"]>.kanban-lane-items .kanban-item").length,b=s.find('.kanban-header-col[data-id="'+p.id+'"]'+(p.asParent?">.kanban-header-col":"")+">.title>.count");b.text(h||(i.options.showZeroCount?0:"")),i.options.onRenderCount&&i.options.onRenderCount(b,h,p,i)}i.adjustKanbanSize(n,s),i.options.onRenderKanban&&i.options.onRenderKanban(s,n,i)},t.prototype.renderKanbanHeader=function(n,t){var d=this;t=t||d.$.children('.kanban-board[data-id="'+n.id+'"]');var i=t.children(".kanban-header");i.length||(i=a('<div class="kanban-header"></div>').prependTo(t),e||i.addClass("clearfix")),i.children(".kanban-col").addClass("kanban-expired");for(var o=n.columns,s={},r=!1,l=0;l<o.length;++l){var c=o[l];if(c.id||(c.id=c.type),c.asParent)r=!0,c.subs=[],s[c.type]=c;else if(c.parentType){var p=s[c.parentType];p.subs.push(c)}}for(var h=null,b=null,l=0;l<o.length;++l){var c=o[l];if(c.asParent)d.renderHeaderParentCol(o[l],i,h,n),h=c,b=null;else if(c.parentType){var p=s[c.parentType];d.renderHeaderCol(o[l],i,p,b,n),b=c}else d.renderHeaderCol(o[l],i,null,h,n),h=c,b=null}this.options.showAddCol&&d.renderHeaderCol({id:"ADD",kanban:n.id,name:d.options.createColumnText,icon:"plus",type:"ADD"},i,null,h,n),i.toggleClass("kanban-header-has-parent",!!r).find(".kanban-expired").remove()},t.prototype.renderHeaderParentCol=function(n,e,t,d){var i=this,o=e.children('.kanban-header-parent-col[data-id="'+n.id+'"]'),s=t?e.children('.kanban-header-col[data-id="'+t.id+'"]'):null;o.length?o.removeClass("kanban-expired").find(".kanban-header-sub-cols>.kanban-col").addClass("kanban-expired"):o=a(['<div class="kanban-col kanban-header-col kanban-header-parent-col" data-id="'+n.id+'">','<div class="kanban-header-col">','<div class="title">','<i class="icon"></i>','<span class="text"></span>',i.options.showCount?'<span class="count"></span>':"","</div>","</div>",'<div class="kanban-header-sub-cols">',"</div>","</div>"].join("")),s&&s.length?s.after(o):e.prepend(o),o.data("col",n),o.attr("data-type",n.type).attr("data-subs-count",n.subs.length);var r=o.children(".kanban-header-col");r.find(".title>.icon").attr("class","icon icon-"+(n.icon||""));var l=r.find(".title>.text").text(n.name);n.color&&l.css("color",n.color),i.options.showCount&&r.find(".title>.count").text(n.count||(i.options.showZeroCount?0:"")),i.options.onRenderHeaderCol&&i.options.onRenderHeaderCol(o,n,e,d)},t.prototype.renderHeaderCol=function(n,e,t,d,i){var o=this;if(n.parentType&&t){var s=e.children('.kanban-header-parent-col[data-id="'+t.id+'"]');s.attr("data-subs-count",t.subs.length),o.options.useFlex&&s.css("flex",t.subs.length+" 1 0%"),e=s.children(".kanban-header-sub-cols")}var r=e.children('.kanban-header-col[data-id="'+n.id+'"]'),l=d?e.children('.kanban-header-col[data-id="'+d.id+'"]'):null,c="ADD"===n.id;if(r.length)r.removeClass("kanban-expired");else{r=a(['<div class="kanban-col kanban-header-col" data-id="'+n.id+'">',"<"+(c?"a":"div")+' class="title">','<i class="icon"></i>','<span class="text"></span>',o.options.showCount?'<span class="count"></span>':"","</"+(c?"a":"div")+">","</div>"].join("")),c?r.children(".title").addClass("action").attr("data-action","addCol"):(r.children(".title").addClass("action-dbc").attr("data-action","editCol"),o.options.readonly||r.append('<div class="actions"></div>'));var p=o.options.minColWidth;p&&r.css("min-width",p);var h=o.options.maxColWidth;h&&r.css("max-width",o.options.maxColWidth)}l&&l.length?l.after(r):e.prepend(r),r.data("col",n),r.attr("data-type",n.type),r.find(".title>.icon").attr("class","icon icon-"+(n.icon||""));var b=r.find(".title>.text").text(n.name);n.color&&b.css("color",n.color),o.options.showCount&&r.find(".title>.count").text(n.count||(o.options.showZeroCount?0:"")),o.options.onRenderHeaderCol&&o.options.onRenderHeaderCol(r,n,e,i)},t.prototype.renderLane=function(n,t,d,i,o){var s=this;d=d||s.$.children('.kanban-board[data-id="'+n.kanban+'"]');var r=d.children('.kanban-lane[data-id="'+n.id+'"]');if(r.length?r.removeClass("kanban-expired"):(r=a('<div class="kanban-lane" data-id="'+n.id+'"></div>').appendTo(d),e||r.addClass("clearfix")),r.attr("data-index",o).data("lane",n),!s.options.noLaneName){var l=r.children('.kanban-lane-name[data-id="'+n.id+'"]');l.length||(l=a('<div class="kanban-lane-name action-dbc" data-action="editLaneName" data-id="'+n.id+'"></div>').appendTo(r)),l.empty().attr("title",n.name).append(a('<span class="text" />').text(n.name)),n.color&&l.css("background-color",n.color),s.options.onRenderLaneName&&s.options.onRenderLaneName(l,n,d,t,i)}if(r.children(".kanban-col,.kanban-sub-lanes").addClass("kanban-expired"),r.toggleClass("has-sub-lane",!!n.subLanes),n.subLanes)s.renderSubLanes(n,t,r,i);else{var c=n.items||n.cards;c&&s.renderLaneItems(t,c,r,n,i)}s.options.showAddCol&&s.renderLaneCol({id:"EMPTY",type:"EMPTY"},r),r.children(".kanban-expired").remove()},t.prototype.renderSubLanes=function(n,e,t,d){var i=this,o=t.children('.kanban-sub-lanes[data-id="'+n.id+'"]');o.length?o.removeClass("kanban-expired"):o=a('<div class="kanban-sub-lanes" data-id="'+n.id+'"></div>').appendTo(t),o.children(".kanban-sub-lane").addClass("kanban-expired");for(var s=0;s<n.subLanes.length;++s){var r=n.subLanes[s];r.$index=s,i.renderSubLane(r,e,o,d,s)}o.toggleClass("no-sub-lane",!n.subLanes.length).attr("data-sub-lanes-count",n.subLanes.length).children(".kanban-expired").remove()},t.prototype.renderSubLane=function(n,t,d,i,o){var s=d.children('.kanban-sub-lane[data-id="'+n.id+'"]');s.length?s.removeClass("kanban-expired"):(s=a('<div class="kanban-sub-lane" data-id="'+n.id+'"></div>').appendTo(d),e||s.addClass("clearfix")),s.attr("data-index",o).data("lane",n),s.children(".kanban-col").addClass("kanban-expired");var r=n.items||n.cards;r&&this.renderLaneItems(t,r,s,n,i),s.children(".kanban-expired").remove()},t.prototype.renderLaneItems=function(a,n,e,t,d){for(var i=this,o=0;o<a.length;++o){var s=a[o];if(!s.asParent){var r=i.renderLaneCol(s,e),l=n[s.type]||[];i.renderColumnItems(s,l,r,t,d)}}},t.prototype.renderColumnItems=function(a,n,e,t,d){var i=e.find(".kanban-lane-items");i.children(".kanban-item").addClass("kanban-expired");for(var o=0;o<n.length;++o){var s=n[o];this.renderLaneItem(s,i,a,t,d)}i.children(".kanban-expired").remove()},t.prototype.renderLaneCol=function(n,e){var t=this,d=e.children('.kanban-lane-col[data-id="'+n.id+'"]');if(d.length)d.removeClass("kanban-expired");else{d=a('<div class="kanban-col kanban-lane-col" data-id="'+n.id+'"></div>').appendTo(e),"EMPTY"!==n.id&&(d.append('<div class="kanban-lane-items"></div>'),t.options.readonly||d.append(['<div class="kanban-lane-actions">','<button class="btn btn-default btn-block action" type="button" data-action="addItem"><span class="text-muted"><i class="icon icon-plus"></i> '+t.options.addItemText+"</span></button>","</div>"].join("")));var i=t.options;i.minColWidth&&d.css("min-width",i.minColWidth),i.maxColWidth&&d.css("max-width",i.maxColWidth),i.maxColHeight&&d.find(".kanban-lane-items").css("max-height",i.maxColHeight),i.laneItemsClass&&d.find(".kanban-lane-items").addClass(i.laneItemsClass),i.laneColClass&&d.addClass(i.laneColClass)}return"EMPTY"===n.id&&d.appendTo(e),d.attr({"data-parent":n.parentType?n.parentType:null,"data-type":n.type}),d},t.prototype.renderLaneItem=function(n,e,t,d,i){var o=e.children('.kanban-item[data-id="'+n.id+'"]');if(o.length?o.removeClass("kanban-expired"):o=a('<div class="kanban-item" data-id="'+n.id+'"></div>').appendTo(e),o.data("item",n),this.options.itemRender)this.options.itemRender(n,o,t,d,i);else{var s=o.find(".title");s.length||(s=a('<div class="title"></div>').appendTo(o)),s.text(n.name||n.title)}return o},t.prototype.adjustKanbanSize=function(n,t){for(var d=this,i=n.columns,o=d.options.noLaneName?0:d.options.laneNameWidth,s=d.options.showAddCol?1:0,r=0;r<i.length;++r)i[r].asParent||s++;var l=d.options.fluidBoardWidth,c=d.options.minColWidth*s+o;if(t=t||d.$.children('.kanban-board[data-id="'+n.id+'"]'),t.removeClass("kanban-size-inited").css(l?"width":"min-width",c),!d.options.useFlex||!e){var p=l?c:Math.max(c,d.$.width()),h=Math.floor((p-o)/s);t.find(".kanban-col").each(function(){var n=a(this),e=h;n.hasClass("kanban-header-parent-col")&&(e*=n.attr("data-subs-count")),n.css("width",e)}),d.options.maxColHeight&&"auto"!==d.options.maxColHeight&&(t.children(".kanban-lane").each(function(){var n=a(this),e=n.height();n.children(".kanban-col,.kanban-sub-lanes").css("min-height",e)}),t.find(".kanban-lane:not(.has-sub-lane),.kanban-sub-lane").each(function(){var n=a(this),e=n.height(),t=n.children(".kanban-lane-col").css("height","auto");t.each(function(){e=Math.max(e,a(this).outerHeight()+1)}),t.css("height",e)})),t.addClass("kanban-size-inited")}},t.prototype.adjustSize=function(){for(var a=0;a<this.data.length;++a)this.adjustKanbanSize(this.data[a])},t.DEFAULTS={minColWidth:100,maxColHeight:400,fluidBoardWidth:!1,showAddCol:!1,laneNameWidth:20,addItemText:"添加条目",createColumnText:"添加看板列",useFlex:!0,itemRender:null,droppable:"auto",readonly:!1,laneColClass:"",noLaneName:!1,showCount:!0,showZeroCount:!1},a.fn.kanban=function(e){return this.each(function(){var d=a(this),i=d.data(n),o="object"==typeof e&&e;i||d.data(n,i=new t(this,o)),"string"==typeof e&&i[e]()})},t.NAME=n,a.fn.kanban.Constructor=t}(jQuery);